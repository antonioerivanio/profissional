ARG CI_REPOSITORY=packages.tce.ce.gov.br
# Estágio de build da aplicação
FROM ${CI_REPOSITORY}/devops/docker/maven:3.8-openjdk8-alpine AS maven

ARG CI_REPOSITORY
ARG CI_REGISTRY_USER
ARG CI_REGISTRY_PASSWORD
ARG MAVEN_CLI_OPTS="-Dmaven.test.skip=true -s settings.xml"

COPY .m2/settings.xml .
COPY pom.xml .
COPY src ./src

RUN set -eux; \
    # Seleção do perfil correto
    grep -lriF "application.properties" src/ | xargs sed -i "s|application.properties|application-kubernetes.properties|"; \
    sed -i "s|<base-name>application</base-name>|<base-name>application-kubernetes</base-name>|" $(find ./src -name "faces-config.xml"); \
    mvn ${MAVEN_CLI_OPTS} clean package


# Estágio do webserver Tomcat
FROM ${CI_REPOSITORY}/devops/docker/tomcat:7.0-openjdk8-jre-alpine

RUN set -eux; \
    # Remoção do conteúdo default do Tomcat do path webapps
    rm -rf webapps/ROOT/*; \
    # Configurando redirecionamento de / para /project_name
    echo "<% response.sendRedirect(\"/srh\"); %>" > webapps/ROOT/index.jsp

# Cópia do arquivo .war a partir do estágio anterior
COPY --from=maven --chown=${TOMCAT_USER}:${TOMCAT_GROUP} target/*.war ${TOMCAT_HOME_DIR}/webapps/srh.war
